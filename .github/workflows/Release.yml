name: Release

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**/*.md'
  workflow_dispatch:

jobs:
  analyze:
    uses: budiardianata/stories/.github/workflows/Lint.yml@main
    secrets:
      MAP_API_KEY: ${{ secrets.MAP_API_KEY }}
      BASE_URL: ${{ secrets.BASE_URL }}

  tests:
    needs: analyze
    uses: budiardianata/stories/.github/workflows/Test.yml@main
    secrets:
      MAP_API_KEY: ${{ secrets.MAP_API_KEY }}
      BASE_URL: ${{ secrets.BASE_URL }}

  build:
    needs: tests
    uses: budiardianata/stories/.github/workflows/Build.yml@main
    secrets:
      MAP_API_KEY: ${{ secrets.MAP_API_KEY }}
      BASE_URL: ${{ secrets.BASE_URL }}

  release:
    needs: [analyze, build]
    name: Release ðŸš€
    runs-on: ubuntu-latest
    steps:
      - name: Download Build Output Artefact ðŸ“¦
        uses: actions/download-artifact@v3
        id: build-result
        with:
          name: build-output

      - name: Bump version and push tag ðŸ“¦
        if: ${{ success() }}
        id: tag_version
        uses: mathieudutour/github-tag-action@v6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create github release ðŸŽ‰
        if: ${{ success() }}
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag_version.outputs.new_tag }}
          name: Release ${{ steps.tag_version.outputs.new_tag }}
          body: ${{ steps.tag_version.outputs.changelog }}
          artifacts: ${{steps.build-result.outputs.download-path}}/**/*.apk
          token: ${{ secrets.GITHUB_TOKEN }}
